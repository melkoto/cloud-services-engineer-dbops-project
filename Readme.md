# cloud-services-engineer-dbops-project

## Описание
В этом проекте реализована нормализация схемы БД интернет-магазина (сосисочной) с использованием миграций Flyway. В проекте реализованы следующие миграции:

- V001__create_tables.sql — создание исходных таблиц.
- V002__change_schema.sql — нормализация схемы (объединение данных, удаление избыточных таблиц, добавление полей).
- V003__insert_data.sql — заполнение таблиц данными.
- V004__create_index.sql — создание индексов для ускорения выполнения запросов.
Также в GitHub Workflow добавлен шаг для выполнения миграций.

## Установка Docker и запуск PostgreSQL
- Установка Docker:
```bash
sudo apt update
sudo apt install docker.io -y
sudo systemctl start docker
sudo systemctl enable docker
```
- Установка Docker Compose:
```bash
sudo apt install docker-compose -y
```
- Запуск контейнера PostgreSQL:
```aml
version: '3.8'
services:
  postgres:
    image: postgres:16
    container_name: postgres
    environment:
      POSTGRES_USER: user
      POSTGRES_PASSWORD: password
      POSTGRES_DB: store_default
    ports:
      - "5432:5432"
    volumes:
      - /opt/docker/postgres/:/var/lib/postgresql/data
    restart: unless-stopped
```

## Запуск контейнера
```bash
docker-compose up -d
```

## Создание новой базы данных и настройка пользователя для миграций
- Подключение к БД:
```bash
psql -h localhost -p 5432 -U user -d store_default
```
- Создание новой базы данных store:
```bash
CREATE DATABASE store;
```
- Создание нового пользователя для миграций
```bash
CREATE USER newuser WITH PASSWORD 'newpassword';
GRANT ALL PRIVILEGES ON DATABASE store TO newuser;
```

## Миграции Flyway
### Миграция V001__create_tables.sql
Создаёт таблицы:
- product (id, name, picture_url, price),
- orders (id, status, date_created),
- order_product (order_id, product_id, quantity).
```sql
CREATE TABLE product (
    id BIGINT PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
    name VARCHAR(255) NOT NULL,
    picture_url VARCHAR(255),
    price DOUBLE PRECISION
);

CREATE TABLE orders (
    id BIGINT PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
    status VARCHAR(255),
    date_created DATE DEFAULT CURRENT_DATE
);

CREATE TABLE order_product (
    quantity INTEGER NOT NULL,
    order_id BIGINT NOT NULL,
    product_id BIGINT NOT NULL
);
```

### Миграция V002__change_schema.sql
Нормализует схему:
- Добавляет столбец price в product (если его ещё нет) и удаляет таблицу product_info.
- Добавляет столбец date_created в orders (если его ещё нет) и удаляет таблицу orders_date.
- Добавляет внешние ключи в order_product.

```sql
-- Нормализация данных о продуктах:
ALTER TABLE product ADD COLUMN IF NOT EXISTS price DOUBLE PRECISION;
DROP TABLE IF EXISTS product_info;

-- Нормализация данных о заказах:
ALTER TABLE orders ADD COLUMN IF NOT EXISTS date_created DATE DEFAULT CURRENT_DATE;
DROP TABLE IF EXISTS orders_date;

-- Обеспечиваем корректные связи между заказами и продуктами:
DO $$
BEGIN
    IF NOT EXISTS (
        SELECT 1 FROM information_schema.table_constraints 
        WHERE constraint_name = 'fk_order_product_product'
          AND table_name = 'order_product'
    ) THEN
        ALTER TABLE order_product
            ADD CONSTRAINT fk_order_product_product FOREIGN KEY (product_id)
            REFERENCES product (id);
    END IF;
END
$$;

DO $$
BEGIN
    IF NOT EXISTS (
        SELECT 1 FROM information_schema.table_constraints 
        WHERE constraint_name = 'fk_order_product_order'
          AND table_name = 'order_product'
    ) THEN
        ALTER TABLE order_product
            ADD CONSTRAINT fk_order_product_order FOREIGN KEY (order_id)
            REFERENCES orders (id);
    END IF;
END
$$;
```
### Миграция V003__insert_data.sql
Заполняет таблицы данными

```sql
TRUNCATE TABLE order_product, orders, product RESTART IDENTITY CASCADE;

-- Заполнение product:
INSERT INTO product (id, name, picture_url, price)
VALUES 
  (1, 'Сливочная', 'https://res.cloudinary.com/sugrobov/image/upload/v1623323635/repos/sausages/6.jpg', 320.00),
  (2, 'Особая', 'https://res.cloudinary.com/sugrobov/image/upload/v1623323635/repos/sausages/5.jpg', 179.00),
  (3, 'Молочная', 'https://res.cloudinary.com/sugrobov/image/upload/v1623323635/repos/sausages/4.jpg', 225.00),
  (4, 'Нюренбергская', 'https://res.cloudinary.com/sugrobov/image/upload/v1623323635/repos/sausages/3.jpg', 315.00),
  (5, 'Мюнхенская', 'https://res.cloudinary.com/sugrobov/image/upload/v1623323635/repos/sausages/2.jpg', 330.00),
  (6, 'Русская', 'https://res.cloudinary.com/sugrobov/image/upload/v1623323635/repos/sausages/1.jpg', 189.00);

-- Заполнение orders:
INSERT INTO orders (id, status, date_created)
SELECT 
  i, 
  (array['pending','shipped','cancelled'])[(i % 3) + 1],
  CURRENT_DATE - (i % 30)
FROM generate_series(1, 100000) s(i);

-- Заполнение order_product:
INSERT INTO order_product (quantity, order_id, product_id)
SELECT 
  (i % 50) + 1,
  i,
  (i % 6) + 1
FROM generate_series(1, 100000) s(i);
```

### Миграция V004__create_index.sql
Создаёт индексы для ускорения выполнения запросов

```sql
DROP INDEX IF EXISTS order_product_order_id_idx;
DROP INDEX IF EXISTS orders_status_date_idx;

CREATE INDEX order_product_order_id_idx ON order_product(order_id);
CREATE INDEX orders_status_date_idx ON orders(status, date_created);
```

## GitHub Workflow
```yml
name: Main workflow
on:
  push:
    branches:
      - main
jobs:
  migrate:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout repository
      uses: actions/checkout@v2

    #### Добавьте шаг с Flyway-миграциями
    - name: Apply migrations with Docker
      run: |
        docker pull flyway/flyway
        docker run --rm --network host -v $(pwd)/migrations:/flyway/sql flyway/flyway migrate \
          -url="jdbc:postgresql://${{ secrets.DB_HOST }}:${{ secrets.DB_PORT }}/${{ secrets.DB_NAME }}" \
          -user=${{ secrets.DB_USER }} \
          -password=${{ secrets.DB_PASSWORD }} \
          -baselineOnMigrate=true -baselineVersion=1


    ### Этот шаг оставьте без изменений
    - name: Download and setup autotests binaries
      run: |
        wget -qO- cloud-services-engineer.gitlab.yandexcloud.net/practicum-cloud-services/dbops-autotests/-/package_files/1/download > dbopstest
        chmod +x ./dbopstest
        mv ./dbopstest /usr/local/bin/dbopstest

    ### Этот шаг оставьте без изменений
    - name: Test
      run: |
        dbopstest \
          -test.v \
          -host=${{ secrets.DB_HOST }} \
          -port=${{ secrets.DB_PORT }} \
          -user=${{ secrets.DB_USER }} \
          -password=${{ secrets.DB_PASSWORD }} \
          -db=${{ secrets.DB_NAME }}

```

## Выдача прав пользователю миграций
```sql
CREATE USER newuser WITH PASSWORD 'newpassword';
GRANT ALL PRIVILEGES ON DATABASE store TO newuser;
```
